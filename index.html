<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ขนำลุงดำ แคมป์ปิ้ง - ระบบจองที่พัก</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Anuphan', sans-serif; background-color: #f3f4f6; }
        .camping-gradient { background: linear-gradient(135deg, #166534 0%, #064e3b 100%); }
        .step-card { display: none; }
        .step-card.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .room-card { transition: all 0.3s ease; border: 2px solid transparent; cursor: pointer; }
        .room-card.selected { border-color: #10b981; background-color: #f0fdf4; }
        .room-card.disabled { opacity: 0.6; cursor: not-allowed; border-color: #ef4444 !important; background-color: #fef2f2 !important; }
    </style>
</head>
<body class="pb-10">
    <div class="camping-gradient text-white p-6 pb-20 rounded-b-[3rem] shadow-lg text-center">
        <h1 class="text-3xl font-bold">ขนำลุงดำ แคมป์ปิ้ง</h1>
        <p class="opacity-80 text-sm mt-2">สัมผัสธรรมชาติ พักผ่อนท่ามกลางขุนเขา</p>
    </div>

    <main class="max-w-md mx-auto -mt-12 px-4">
        <!-- Step 1: เลือกวันที่และห้องพัก -->
        <div id="step1" class="step-card active bg-white rounded-3xl p-6 shadow-xl border border-gray-100">
            <h2 class="text-xl font-bold text-emerald-900 mb-4 flex items-center">
                <span class="bg-emerald-100 text-emerald-700 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm">1</span>
                เลือกวันที่เข้าพัก
            </h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs text-gray-500 mb-1 block">วันที่เข้าพัก</label>
                    <input type="date" id="checkIn" class="w-full border-gray-200 border p-3 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm" onchange="setMinCheckOut()">
                </div>
                <div>
                    <label class="text-xs text-gray-500 mb-1 block">วันที่ออก</label>
                    <input type="date" id="checkOut" class="w-full border-gray-200 border p-3 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                </div>
            </div>

            <h2 class="text-xl font-bold text-emerald-900 mb-4 flex items-center">
                <span class="bg-emerald-100 text-emerald-700 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm">2</span>
                เลือกที่พัก
            </h2>
            
            <div id="roomContainer" class="space-y-4">
                <!-- 1. โฮมสเตย์หนำโป -->
                <div class="room-card p-4 rounded-2xl bg-white shadow-sm border border-gray-100" onclick="selectRoom(this, 'โฮมสเตย์หนำโป', 'homestay')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800">โฮมสเตย์หนำโป</h3>
                            <p class="text-[10px] text-gray-400">4-5 คน 1,600.- / 6-8 คน 2,200.-</p>
                        </div>
                        <span class="status-badge bg-emerald-100 text-emerald-600 text-[10px] font-bold px-2 py-0.5 rounded-full">ว่าง</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs text-gray-500">จำนวนคน:</span>
                        <select class="people-dropdown bg-gray-50 border border-gray-200 rounded-lg text-xs p-1 outline-none" onclick="event.stopPropagation()">
                            <option value="4">4 คน</option><option value="5">5 คน</option>
                            <option value="6">6 คน</option><option value="7">7 คน</option><option value="8">8 คน</option>
                        </select>
                    </div>
                </div>

                <!-- 2. บ้านพักริมน้ำ 1 -->
                <div class="room-card p-4 rounded-2xl bg-white shadow-sm border border-gray-100" onclick="selectRoom(this, 'บ้านพักริมน้ำ 1', 'rimnam')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800">บ้านพักริมน้ำ 1</h3>
                            <p class="text-[10px] text-emerald-600">ฟรีอาหารเช้า</p>
                            <p class="text-[10px] text-gray-400">1-2 คน 1,400.- / 3 คน 1,750.-</p>
                        </div>
                        <span class="status-badge bg-emerald-100 text-emerald-600 text-[10px] font-bold px-2 py-0.5 rounded-full">ว่าง</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs text-gray-500">จำนวนคน:</span>
                        <select class="people-dropdown bg-gray-50 border border-gray-200 rounded-lg text-xs p-1 outline-none" onclick="event.stopPropagation()">
                            <option value="1">1 คน</option><option value="2">2 คน</option><option value="3">3 คน</option>
                        </select>
                    </div>
                </div>

                <!-- 3. บ้านพักริมน้ำ 2 -->
                <div class="room-card p-4 rounded-2xl bg-white shadow-sm border border-gray-100" onclick="selectRoom(this, 'บ้านพักริมน้ำ 2', 'rimnam')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800">บ้านพักริมน้ำ 2</h3>
                            <p class="text-[10px] text-emerald-600">ฟรีอาหารเช้า</p>
                            <p class="text-[10px] text-gray-400">1-2 คน 1,400.- / 3 คน 1,750.-</p>
                        </div>
                        <span class="status-badge bg-emerald-100 text-emerald-600 text-[10px] font-bold px-2 py-0.5 rounded-full">ว่าง</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs text-gray-500">จำนวนคน:</span>
                        <select class="people-dropdown bg-gray-50 border border-gray-200 rounded-lg text-xs p-1 outline-none" onclick="event.stopPropagation()">
                            <option value="1">1 คน</option><option value="2">2 คน</option><option value="3">3 คน</option>
                        </select>
                    </div>
                </div>

                <!-- 4. เต็นท์กระโจม 1 -->
                <div class="room-card p-4 rounded-2xl bg-white shadow-sm border border-gray-100" onclick="selectRoom(this, 'เต็นท์กระโจม 1', 'kra-jom')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800">เต็นท์กระโจม 1</h3>
                            <p class="text-[10px] text-emerald-600">ฟรีอาหารเช้า</p>
                            <p class="text-[10px] text-gray-400">1-2 คน 1,200.- / 3-4 คน 1,550.-</p>
                        </div>
                        <span class="status-badge bg-emerald-100 text-emerald-600 text-[10px] font-bold px-2 py-0.5 rounded-full">ว่าง</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs text-gray-500">จำนวนคน:</span>
                        <select class="people-dropdown bg-gray-50 border border-gray-200 rounded-lg text-xs p-1 outline-none" onclick="event.stopPropagation()">
                            <option value="1">1 คน</option><option value="2">2 คน</option>
                            <option value="3">3 คน</option><option value="4">4 คน</option>
                        </select>
                    </div>
                </div>

                <!-- 5. เต็นท์กระโจม 2 -->
                <div class="room-card p-4 rounded-2xl bg-white shadow-sm border border-gray-100" onclick="selectRoom(this, 'เต็นท์กระโจม 2', 'kra-jom')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800">เต็นท์กระโจม 2</h3>
                            <p class="text-[10px] text-emerald-600">ฟรีอาหารเช้า</p>
                            <p class="text-[10px] text-gray-400">1-2 คน 1,200.- / 3-4 คน 1,550.-</p>
                        </div>
                        <span class="status-badge bg-emerald-100 text-emerald-600 text-[10px] font-bold px-2 py-0.5 rounded-full">ว่าง</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs text-gray-500">จำนวนคน:</span>
                        <select class="people-dropdown bg-gray-50 border border-gray-200 rounded-lg text-xs p-1 outline-none" onclick="event.stopPropagation()">
                            <option value="1">1 คน</option><option value="2">2 คน</option>
                            <option value="3">3 คน</option><option value="4">4 คน</option>
                        </select>
                    </div>
                </div>

                <!-- 6. เช่าเต็นท์สนาม K1 -->
                <div class="room-card p-4 rounded-2xl bg-white shadow-sm border border-gray-100" onclick="selectRoom(this, 'เต็นท์สนาม K1', 'field-tent')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800">เช่าเต็นท์สนาม K1</h3>
                            <p class="text-[10px] text-emerald-600">ฟรีอาหารเช้า</p>
                            <p class="text-[10px] text-gray-400">1-2 คน 700.-</p>
                        </div>
                        <span class="status-badge bg-emerald-100 text-emerald-600 text-[10px] font-bold px-2 py-0.5 rounded-full">ว่าง</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs text-gray-500">จำนวนคน:</span>
                        <select class="people-dropdown bg-gray-50 border border-gray-200 rounded-lg text-xs p-1 outline-none" onclick="event.stopPropagation()">
                            <option value="1">1 คน</option><option value="2">2 คน</option>
                        </select>
                    </div>
                </div>

                <!-- 7. เช่าเต็นท์สนาม K2 -->
                <div class="room-card p-4 rounded-2xl bg-white shadow-sm border border-gray-100" onclick="selectRoom(this, 'เต็นท์สนาม K2', 'field-tent')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800">เช่าเต็นท์สนาม K2</h3>
                            <p class="text-[10px] text-emerald-600">ฟรีอาหารเช้า</p>
                            <p class="text-[10px] text-gray-400">1-2 คน 700.-</p>
                        </div>
                        <span class="status-badge bg-emerald-100 text-emerald-600 text-[10px] font-bold px-2 py-0.5 rounded-full">ว่าง</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs text-gray-500">จำนวนคน:</span>
                        <select class="people-dropdown bg-gray-50 border border-gray-200 rounded-lg text-xs p-1 outline-none" onclick="event.stopPropagation()">
                            <option value="1">1 คน</option><option value="2">2 คน</option>
                        </select>
                    </div>
                </div>

                <!-- 8. ลานกางเต็นท์ -->
                <div class="room-card p-4 rounded-2xl bg-white shadow-sm border border-gray-100" onclick="selectRoom(this, 'ลานกางเต็นท์', 'camping-ground')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800">ลานกางเต็นท์</h3>
                            <p class="text-[10px] text-gray-400">150.- / คน / คืน (จ่ายมัดจำ 100%)</p>
                        </div>
                        <span class="status-badge bg-emerald-100 text-emerald-600 text-[10px] font-bold px-2 py-0.5 rounded-full">ว่าง</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs text-gray-500">จำนวนคน:</span>
                        <select class="people-dropdown bg-gray-50 border border-gray-200 rounded-lg text-xs p-1 outline-none" onclick="event.stopPropagation()">
                            <script>
                                for(let i=1; i<=20; i++) document.write(`<option value="${i}">${i} คน</option>`);
                            </script>
                        </select>
                    </div>
                </div>
            </div>

            <button onclick="goToStep(2)" class="w-full mt-8 bg-emerald-700 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-emerald-800 transition">ถัดไป</button>
        </div>

        <!-- Step 2: รายละเอียดการจอง -->
        <div id="step2" class="step-card bg-white rounded-3xl p-6 shadow-xl border border-gray-100">
            <h2 class="text-xl font-bold text-emerald-900 mb-4 flex items-center">
                <span class="bg-emerald-100 text-emerald-700 w-8 h-8 rounded-full flex items-center justify-center mr-2 text-sm">3</span>
                สั่งอาหารล่วงหน้า
            </h2>
            <div id="foodList" class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                    <span class="text-sm font-medium">ชุดหมูกระทะลุงดำ (390.-)</span>
                    <input type="number" value="0" min="0" class="food-qty w-16 p-1 border rounded text-center outline-none" data-name="ชุดหมูกระทะลุงดำ" data-price="390" onchange="calculatePrices()">
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                  <span class="text-sm font-medium">เซ็ตอาหารพื้นบ้าน (390.-)</span>
                  <input type="number" value="0" min="0" class="food-qty w-16 p-1 border rounded text-center outline-none" data-name="เซ็ตอาหารพื้นบ้าน" data-price="390" onchange="calculatePrices()">
                </div>
            </div>

            <div class="mt-6">
                <label class="text-sm font-bold text-gray-700 block mb-2">ชื่อผู้จอง</label>
                <input type="text" id="custName" placeholder="ชื่อ-นามสกุล" class="w-full border-gray-200 border p-3 rounded-xl mb-4 outline-none focus:border-emerald-500">
                
                <label class="text-sm font-bold text-gray-700 block mb-2">เบอร์โทรศัพท์</label>
                <input type="tel" id="custPhone" placeholder="08x-xxxxxxx" class="w-full border-gray-200 border p-3 rounded-xl mb-4 outline-none focus:border-emerald-500">

                <label class="text-sm font-bold text-emerald-700 block mb-2">สรุปยอดชำระ</label>
            </div>

            <div class="mt-2 pt-4 border-t border-dashed">
                <div class="flex justify-between text-gray-600 mb-2 text-sm"><span>ราคาที่พักรวม</span><span id="displayRoomPrice">0.-</span></div>
                <div class="flex justify-between text-gray-600 mb-2 text-sm"><span>ค่าอาหารเสริม</span><span id="displayFoodPrice">0.-</span></div>
                <div class="flex justify-between text-emerald-700 font-bold text-lg border-t pt-2">
                    <span>ยอดมัดจำที่ต้องโอน</span>
                    <span id="displayDeposit">0.-</span>
                </div>
                <p id="depositNotice" class="text-[10px] text-gray-400 mt-2">* มัดจำที่พัก 50% + ค่าอาหาร 100% (ลานกางเต็นท์มัดจำ 100%)</p>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-8">
                <button onclick="goToStep(1)" class="bg-gray-100 text-gray-600 py-4 rounded-2xl font-bold">ย้อนกลับ</button>
                <button onclick="goToStep(3)" class="bg-emerald-700 text-white py-4 rounded-2xl font-bold shadow-lg">ชำระเงิน</button>
            </div>
        </div>

        <!-- Step 3: ชำระเงิน -->
        <div id="step3" class="step-card bg-white rounded-3xl p-6 shadow-xl border border-gray-100">
            <h2 class="text-xl font-bold text-emerald-900 mb-4 text-center">ชำระมัดจำ</h2>
            <div class="bg-gray-50 p-4 rounded-2xl text-center mb-6">
                <div class="bg-white p-4 inline-block rounded-xl border-2 border-emerald-500 mb-3 shadow-inner">
                    <img id="qrCode" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=0615924262" class="w-48 h-48 mx-auto" alt="PromptPay QR">
                </div>
                <p class="font-bold text-2xl text-emerald-800" id="finalPriceText">0.00 บาท</p>
                <div class="mt-2 text-sm text-gray-600 bg-white py-2 rounded-lg border border-gray-100">
                    <p>กสิกรไทย: 061-5-92426-2</p>
                    <p>อลงกต ทวีผ่อง</p>
                </div>
            </div>

            <label class="block mb-6">
                <span class="text-sm font-bold text-gray-700 block mb-2 text-center">อัปโหลดสลิปยืนยันการโอน</span>
                <input type="file" id="slipInput" accept="image/*" class="w-full text-xs text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-700 file:text-white hover:file:bg-emerald-800">
            </label>

            <button onclick="submitBooking()" id="submitBtn" class="w-full bg-emerald-700 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-emerald-800 transition">ยืนยันและแจ้งการโอน</button>
        </div>
    </main>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwCfEmFkQ5bjats998463XFT2s6tvM1bqJFvx8rOJiKs4tlvHxXwLXRQeFGPYPkO9CNSw/exec'; // URL Google Apps Script

        window.onload = function() {
            // ตั้งค่าวันที่เริ่มต้นเป็นวันพรุ่งนี้
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            const checkInInput = document.getElementById('checkIn');
            checkInInput.min = tomorrowStr;
            checkInInput.value = tomorrowStr;
            
            setMinCheckOut();
            
            liff.init({ liffId: "2008803474-hRJaVbm7" }).then(() => {
                if (!liff.isLoggedIn()) liff.login();
            }).catch(err => console.error("LIFF Init Error:", err));
        };

        function setMinCheckOut() {
            const checkInVal = document.getElementById('checkIn').value;
            const checkOutInput = document.getElementById('checkOut');
            const nextDay = new Date(checkInVal);
            nextDay.setDate(nextDay.getDate() + 1);
            checkOutInput.min = nextDay.toISOString().split('T')[0];
            checkOutInput.value = nextDay.toISOString().split('T')[0];
        }

        let selectedRooms = [];

        function selectRoom(el, name, type) {
            if(el.classList.contains('disabled')) return;
            
            el.classList.toggle('selected');
            const isSelected = el.classList.contains('selected');
            
            if(isSelected) {
                selectedRooms.push({ el, name, type });
            } else {
                selectedRooms = selectedRooms.filter(r => r.el !== el);
            }
        }

        function calculatePrices() {
            let roomTotal = 0;
            let depositTotal = 0;
            let foodTotal = 0;

            selectedRooms.forEach(room => {
                const people = parseInt(room.el.querySelector('.people-dropdown').value);
                let price = 0;
                let depositRate = 0.5;

                switch(room.type) {
                    case 'homestay':
                        price = (people <= 5) ? 1600 : 2200;
                        break;
                    case 'rimnam':
                        price = (people <= 2) ? 1400 : 1750;
                        break;
                    case 'kra-jom':
                        price = (people <= 2) ? 1200 : 1550;
                        break;
                    case 'field-tent':
                        price = 700;
                        break;
                    case 'camping-ground':
                        price = people * 150;
                        depositRate = 1.0; // มัดจำ 100%
                        break;
                }
                roomTotal += price;
                depositTotal += (price * depositRate);
            });

            document.querySelectorAll('.food-qty').forEach(input => {
                const qty = parseInt(input.value);
                if (qty > 0) {
                    foodTotal += (parseInt(input.getAttribute('data-price')) * qty);
                }
            });

            depositTotal += foodTotal;

            document.getElementById('displayRoomPrice').innerText = roomTotal.toLocaleString() + '.-';
            document.getElementById('displayFoodPrice').innerText = foodTotal.toLocaleString() + '.-';
            document.getElementById('displayDeposit').innerText = depositTotal.toLocaleString() + '.-';
            document.getElementById('finalPriceText').innerText = depositTotal.toLocaleString() + ' บาท';
            
            return { roomTotal, foodTotal, depositTotal };
        }

        function goToStep(step) {
            if(step === 2) {
                if(selectedRooms.length === 0) return alert('กรุณาเลือกห้องพักอย่างน้อย 1 รายการ');
                calculatePrices();
            }
            document.querySelectorAll('.step-card').forEach(c => c.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            window.scrollTo(0,0);
        }

        async function submitBooking() {
            const fileInput = document.getElementById('slipInput');
            if (!fileInput.files[0]) return alert('กรุณาแนบรูปภาพสลิปการโอนเงิน');
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = 'กำลังบันทึกข้อมูล...';

            const prices = calculatePrices();
            const reader = new FileReader();
            
            reader.onload = async function() {
                const base64 = reader.result.split(',')[1];
                let profile = { userId: 'guest', displayName: 'Guest' };
                
                try {
                    if (liff.isLoggedIn()) profile = await liff.getProfile();
                } catch(e) {}
                
                const payload = {
                    lineId: profile.userId,
                    customerName: document.getElementById('custName').value,
                    phone: document.getElementById('custPhone').value,
                    checkIn: document.getElementById('checkIn').value,
                    checkOut: document.getElementById('checkOut').value,
                    rooms: selectedRooms.map(r => ({
                        name: r.name,
                        people: r.el.querySelector('.people-dropdown').value
                    })),
                    totalPrice: prices.roomTotal + prices.foodTotal,
                    deposit: prices.depositTotal,
                    slipBase64: base64
                };

                if (typeof google !== 'undefined') {
                    google.script.run.withSuccessHandler(() => {
                        alert('จองสำเร็จ! เจ้าหน้าที่จะตรวจสอบสลิปและยืนยันการจองผ่าน LINE ครับ');
                        liff.closeWindow();
                    }).processBooking(payload);
                } else {
                    console.log("Mock Submit:", payload);
                    alert('ส่งข้อมูลจำลองสำเร็จ (โปรดตั้งค่า WEB_APP_URL ใน Code จริง)');
                    btn.disabled = false;
                    btn.innerText = 'ยืนยันและแจ้งการโอน';
                }
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
    </script>
</body>
</html>
